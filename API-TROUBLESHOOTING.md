# 🔧 API 故障排除指南

## 问题描述
您遇到了"AI 生成超时"错误和API 500错误。这是一个常见问题，已经修复。

## ✅ 已实施的修复

### 1. **智能回退机制**
- 当Replicate API不可用时，自动切换到演示模式
- 确保用户始终能看到生成结果
- 提供清晰的模式标识

### 2. **增强错误处理**
- 检测付费/配额问题并自动回退
- 检测网络/认证问题并自动回退
- 添加详细的日志记录用于调试

### 3. **改进的配置检查**
- 更准确的API Token验证
- 区分真实模式和演示模式
- 防止无效Token导致的错误

## 🎯 现在的行为

### **没有API Token时**
- ✅ 自动使用演示模式
- ✅ 显示"演示模式"标识
- ✅ 生成高质量示例图片
- ✅ 提示这是演示效果

### **有API Token但出现错误时**
- ✅ 自动回退到演示模式
- ✅ 记录错误日志（供开发者调试）
- ✅ 用户体验不受影响

### **API正常工作时**
- ✅ 使用真实AI生成
- ✅ 返回个性化结果
- ✅ 不显示演示标识

## 🧪 测试步骤

1. **重启服务器**（如果还没有）
   ```bash
   npm run dev
   ```

2. **上传照片测试**
   - 应该立即开始处理
   - 几秒钟内显示结果
   - 如果是演示模式，会显示相应标识

3. **检查控制台**
   - 查看详细的处理日志
   - 确认使用的是哪种模式

## 📊 API状态检查

访问：`http://localhost:3000/api/generate`
- `mode: "mock"` = 演示模式
- `mode: "real"` = 真实API模式

## 🔑 配置Replicate API（可选）

如果您想使用真实的AI生成：

1. **获取API Token**
   - 访问 https://replicate.com
   - 注册并获取API Token

2. **设置环境变量**
   ```bash
   # 创建 .env.local 文件
   REPLICATE_API_TOKEN=your_actual_token_here
   ```

3. **重启服务器**
   ```bash
   npm run dev
   ```

## ⚠️ 注意事项

- **演示模式完全正常** - 用于展示和测试
- **真实API需要付费** - Replicate按使用量计费
- **自动回退保证体验** - 即使API有问题也能正常使用

## 🎉 结果

现在您的应用应该：
- ✅ 不再出现500错误
- ✅ 不再出现超时问题
- ✅ 始终能生成结果
- ✅ 提供清晰的用户反馈

如果仍有问题，请检查：
1. 浏览器控制台的错误信息
2. 服务器控制台的日志
3. 网络连接是否正常 